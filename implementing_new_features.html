<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Implementing new features - Guide to Rustc Development</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A guide to developing rustc">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="about-this-guide.html">About this guide</a></li><li class="spacer"></li><li><a href="part-1-intro.html"><strong aria-hidden="true">1.</strong> Part 1: Building, debugging, and contributing to Rustc</a></li><li><a href="compiler-team.html"><strong aria-hidden="true">2.</strong> About the compiler team</a></li><li><a href="how-to-build-and-run.html"><strong aria-hidden="true">3.</strong> How to build the compiler and run what you built</a></li><li><ol class="section"><li><a href="build-install-distribution-artifacts.html"><strong aria-hidden="true">3.1.</strong> Build and Install distribution artifacts</a></li><li><a href="compiler-documenting.html"><strong aria-hidden="true">3.2.</strong> Documenting Compiler</a></li></ol></li><li><a href="tests/intro.html"><strong aria-hidden="true">4.</strong> The compiler testing framework</a></li><li><ol class="section"><li><a href="tests/running.html"><strong aria-hidden="true">4.1.</strong> Running tests</a></li><li><a href="tests/adding.html"><strong aria-hidden="true">4.2.</strong> Adding new tests</a></li><li><a href="compiletest.html"><strong aria-hidden="true">4.3.</strong> Using compiletest + commands to control test execution</a></li></ol></li><li><a href="walkthrough.html"><strong aria-hidden="true">5.</strong> Walkthrough: a typical contribution</a></li><li><a href="implementing_new_features.html" class="active"><strong aria-hidden="true">6.</strong> Implementing new features</a></li><li><a href="stabilization_guide.html"><strong aria-hidden="true">7.</strong> Stabilizing Features</a></li><li><a href="compiler-debugging.html"><strong aria-hidden="true">8.</strong> Debugging the Compiler</a></li><li><a href="profiling.html"><strong aria-hidden="true">9.</strong> Profiling the compiler</a></li><li><ol class="section"><li><a href="profiling/with_perf.html"><strong aria-hidden="true">9.1.</strong> with the linux perf tool</a></li></ol></li><li><a href="conventions.html"><strong aria-hidden="true">10.</strong> Coding conventions</a></li><li><a href="crates-io.html"><strong aria-hidden="true">11.</strong> crates.io Dependencies</a></li><li class="spacer"></li><li><a href="part-2-intro.html"><strong aria-hidden="true">12.</strong> Part 2: How rustc works</a></li><li><a href="high-level-overview.html"><strong aria-hidden="true">13.</strong> High-level overview of the compiler source</a></li><li><a href="rustc-driver.html"><strong aria-hidden="true">14.</strong> The Rustc Driver and Interface</a></li><li><ol class="section"><li><a href="rustdoc.html"><strong aria-hidden="true">14.1.</strong> Rustdoc</a></li></ol></li><li><a href="query.html"><strong aria-hidden="true">15.</strong> Queries: demand-driven compilation</a></li><li><ol class="section"><li><a href="queries/query-evaluation-model-in-detail.html"><strong aria-hidden="true">15.1.</strong> The Query Evaluation Model in Detail</a></li><li><a href="queries/incremental-compilation.html"><strong aria-hidden="true">15.2.</strong> Incremental compilation</a></li><li><a href="queries/incremental-compilation-in-detail.html"><strong aria-hidden="true">15.3.</strong> Incremental compilation In Detail</a></li><li><a href="incrcomp-debugging.html"><strong aria-hidden="true">15.4.</strong> Debugging and Testing</a></li></ol></li><li><a href="the-parser.html"><strong aria-hidden="true">16.</strong> The parser</a></li><li><a href="test-implementation.html"><strong aria-hidden="true">17.</strong> #[test] Implementation</a></li><li><a href="macro-expansion.html"><strong aria-hidden="true">18.</strong> Macro expansion</a></li><li><a href="name-resolution.html"><strong aria-hidden="true">19.</strong> Name resolution</a></li><li><a href="hir.html"><strong aria-hidden="true">20.</strong> The HIR (High-level IR)</a></li><li><ol class="section"><li><a href="lowering.html"><strong aria-hidden="true">20.1.</strong> Lowering AST to HIR</a></li><li><a href="hir-debugging.html"><strong aria-hidden="true">20.2.</strong> Debugging</a></li></ol></li><li><a href="ty.html"><strong aria-hidden="true">21.</strong> The ty module: representing types</a></li><li><a href="kinds.html"><strong aria-hidden="true">22.</strong> Kinds</a></li><li><a href="type-inference.html"><strong aria-hidden="true">23.</strong> Type inference</a></li><li><a href="traits/resolution.html"><strong aria-hidden="true">24.</strong> Trait solving (old-style)</a></li><li><ol class="section"><li><a href="traits/hrtb.html"><strong aria-hidden="true">24.1.</strong> Higher-ranked trait bounds</a></li><li><a href="traits/caching.html"><strong aria-hidden="true">24.2.</strong> Caching subtleties</a></li><li><a href="traits/specialization.html"><strong aria-hidden="true">24.3.</strong> Specialization</a></li></ol></li><li><a href="traits/index.html"><strong aria-hidden="true">25.</strong> Trait solving (new-style)</a></li><li><ol class="section"><li><a href="traits/lowering-to-logic.html"><strong aria-hidden="true">25.1.</strong> Lowering to logic</a></li><li><ol class="section"><li><a href="traits/goals-and-clauses.html"><strong aria-hidden="true">25.1.1.</strong> Goals and clauses</a></li><li><a href="traits/associated-types.html"><strong aria-hidden="true">25.1.2.</strong> Equality and associated types</a></li><li><a href="traits/implied-bounds.html"><strong aria-hidden="true">25.1.3.</strong> Implied bounds</a></li><li><a href="traits/regions.html"><strong aria-hidden="true">25.1.4.</strong> Region constraints</a></li><li><a href="traits/lowering-module.html"><strong aria-hidden="true">25.1.5.</strong> The lowering module in rustc</a></li><li><a href="traits/lowering-rules.html"><strong aria-hidden="true">25.1.6.</strong> Lowering rules</a></li><li><a href="traits/wf.html"><strong aria-hidden="true">25.1.7.</strong> Well-formedness checking</a></li></ol></li><li><a href="traits/canonical-queries.html"><strong aria-hidden="true">25.2.</strong> Canonical queries</a></li><li><ol class="section"><li><a href="traits/canonicalization.html"><strong aria-hidden="true">25.2.1.</strong> Canonicalization</a></li></ol></li><li><a href="traits/slg.html"><strong aria-hidden="true">25.3.</strong> The SLG solver</a></li><li><a href="traits/chalk-overview.html"><strong aria-hidden="true">25.4.</strong> An Overview of Chalk</a></li><li><a href="traits/bibliography.html"><strong aria-hidden="true">25.5.</strong> Bibliography</a></li></ol></li><li><a href="type-checking.html"><strong aria-hidden="true">26.</strong> Type checking</a></li><li><ol class="section"><li><a href="method-lookup.html"><strong aria-hidden="true">26.1.</strong> Method Lookup</a></li><li><a href="variance.html"><strong aria-hidden="true">26.2.</strong> Variance</a></li><li><a href="existential-types.html"><strong aria-hidden="true">26.3.</strong> Existential Types</a></li></ol></li><li><a href="mir/index.html"><strong aria-hidden="true">27.</strong> The MIR (Mid-level IR)</a></li><li><ol class="section"><li><a href="mir/construction.html"><strong aria-hidden="true">27.1.</strong> MIR construction</a></li><li><a href="mir/visitor.html"><strong aria-hidden="true">27.2.</strong> MIR visitor and traversal</a></li><li><a href="mir/passes.html"><strong aria-hidden="true">27.3.</strong> MIR passes: getting the MIR for a function</a></li><li><a href="mir/optimizations.html"><strong aria-hidden="true">27.4.</strong> MIR optimizations</a></li><li><a href="mir/debugging.html"><strong aria-hidden="true">27.5.</strong> Debugging</a></li></ol></li><li><a href="borrow_check.html"><strong aria-hidden="true">28.</strong> The borrow checker</a></li><li><ol class="section"><li><a href="borrow_check/moves_and_initialization.html"><strong aria-hidden="true">28.1.</strong> Tracking moves and initialization</a></li><li><ol class="section"><li><a href="borrow_check/moves_and_initialization/move_paths.html"><strong aria-hidden="true">28.1.1.</strong> Move paths</a></li></ol></li><li><a href="borrow_check/type_check.html"><strong aria-hidden="true">28.2.</strong> MIR type checker</a></li><li><a href="borrow_check/region_inference.html"><strong aria-hidden="true">28.3.</strong> Region inference</a></li></ol></li><li><a href="const-eval.html"><strong aria-hidden="true">29.</strong> Constant evaluation</a></li><li><ol class="section"><li><a href="miri.html"><strong aria-hidden="true">29.1.</strong> miri const evaluator</a></li></ol></li><li><a href="param_env.html"><strong aria-hidden="true">30.</strong> Parameter Environments</a></li><li><a href="codegen.html"><strong aria-hidden="true">31.</strong> Code Generation</a></li><li><ol class="section"><li><a href="codegen/updating-llvm.html"><strong aria-hidden="true">31.1.</strong> Updating LLVM</a></li><li><a href="codegen/debugging.html"><strong aria-hidden="true">31.2.</strong> Debugging LLVM</a></li></ol></li><li><a href="diag.html"><strong aria-hidden="true">32.</strong> Emitting Diagnostics</a></li><li><ol class="section"><li><a href="diag/json-format.html"><strong aria-hidden="true">32.1.</strong> JSON diagnostic format</a></li><li class="spacer"></li></ol></li><li><a href="appendix/stupid-stats.html">Appendix A: Stupid Stats</a></li><li class="affix"><a href="appendix/background.html">Appendix B: Background material</a></li><li class="affix"><a href="appendix/glossary.html">Appendix C: Glossary</a></li><li class="affix"><a href="appendix/code-index.html">Appendix D: Code Index</a></li><li class="affix"><a href="important-links.html"></a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Guide to Rustc Development</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#implement-new-feature" id="implement-new-feature"><h1>Implement New Feature</h1></a>
<p>When you want to implement a new significant feature in the compiler,
you need to go through this process to make sure everything goes
smoothly.</p>
<a class="header" href="#the-rfcbot-pfcp-process" id="the-rfcbot-pfcp-process"><h2>The @rfcbot (p)FCP process</h2></a>
<p>When the change is small and uncontroversial, then it can be done
with just writing a PR and getting r+ from someone who knows that
part of the code. However, if the change is potentially controversial,
it would be a bad idea to push it without consensus from the rest
of the team (both in the &quot;distributed system&quot; sense to make sure
you don't break anything you don't know about, and in the social
sense to avoid PR fights).</p>
<p>If such a change seems to be too small to require a full formal RFC
process (e.g. a big refactoring of the code, or a
&quot;technically-breaking&quot; change, or a &quot;big bugfix&quot; that basically
amounts to a small feature) but is still too controversial or
big to get by with a single r+, you can start a pFCP (or, if you
don't have r+ rights, ask someone who has them to start one - and
unless they have a concern themselves, they should).</p>
<p>Again, the pFCP process is only needed if you need consensus - if you
don't think anyone would have a problem with your change, it's ok to
get by with only an r+. For example, it is OK to add or modify
unstable command-line flags or attributes without an pFCP for
compiler development or standard library use, as long as you don't
expect them to be in wide use in the nightly ecosystem.</p>
<p>You don't need to have the implementation fully ready for r+ to ask
for a pFCP, but it is generally a good idea to have at least a proof
of concept so that people can see what you are talking about.</p>
<p>That starts a &quot;proposed final comment period&quot; (pFCP), which requires
all members of the team to sign off the FCP. After they all do so,
there's a week long &quot;final comment period&quot; where everybody can comment,
and if no new concerns are raised, the PR/issue gets FCP approval.</p>
<a class="header" href="#the-logistics-of-writing-features" id="the-logistics-of-writing-features"><h2>The logistics of writing features</h2></a>
<p>There are a few &quot;logistic&quot; hoops you might need to go through in
order to implement a feature in a working way.</p>
<a class="header" href="#warning-cycles" id="warning-cycles"><h3>Warning Cycles</h3></a>
<p>In some cases, a feature or bugfix might break some existing programs
in some edge cases. In that case, you might want to do a crater run
to assess the impact and possibly add a future-compatibility lint,
similar to those used for
<a href="./diag.html#edition-gated-lints">edition-gated lints</a>.</p>
<a class="header" href="#stability" id="stability"><h3>Stability</h3></a>
<p>We <a href="https://github.com/rust-lang/rfcs/blob/master/text/1122-language-semver.md">value the stability of Rust</a>. Code that works and runs on stable
should (mostly) not break. Because of that, we don't want to release
a feature to the world with only team consensus and code review -
we want to gain real-world experience on using that feature on nightly,
and we might want to change the feature based on that experience.</p>
<p>To allow for that, we must make sure users don't accidentally depend
on that new feature - otherwise, especially if experimentation takes
time or is delayed and the feature takes the trains to stable,
it would end up de facto stable and we'll not be able to make changes
in it without breaking people's code.</p>
<p>The way we do that is that we make sure all new features are feature
gated - they can't be used without a enabling a feature gate
(<code>#[feature(foo)]</code>), which can't be done in a stable/beta compiler.
See the <a href="#stability-in-code">stability in code</a> section for the technical details.</p>
<p>Eventually, after we gain enough experience using the feature,
make the necessary changes, and are satisfied, we expose it to
the world using the stabilization process described <a href="https://rust-lang.github.io/rustc-guide/stabilization_guide.html">here</a>.
Until then, the feature is not set in stone: every part of the
feature can be changed, or the feature might be completely
rewritten or removed. Features are not supposed to gain tenure
by being unstable and unchanged for a year.</p>
<p><a name = "tracking-issue"></a></p>
<a class="header" href="#tracking-issues" id="tracking-issues"><h3>Tracking Issues</h3></a>
<p>To keep track of the status of an unstable feature, the
experience we get while using it on nightly, and of the
concerns that block its stabilization, every feature-gate
needs a tracking issue.</p>
<p>General discussions about the feature should be done on
the tracking issue.</p>
<p>For features that have an RFC, you should use the RFC's
tracking issue for the feature.</p>
<p>For other features, you'll have to make a tracking issue
for that feature. The issue title should be &quot;Tracking issue
for YOUR FEATURE&quot;.</p>
<p>For tracking issues for features (as opposed to future-compat
warnings), I don't think the description has to contain
anything specific. Generally we put the list of items required
for stabilization using a github list, e.g.</p>
<pre><code class="language-txt">    **Steps:**

    - [ ] Implement the RFC (cc @rust-lang/compiler -- can anyone write
          up mentoring instructions?)
    - [ ] Adjust documentation ([see instructions on forge][doc-guide])
    - Note: no stabilization step here.
</code></pre>
<p><a name="stability-in-code"></a></p>
<a class="header" href="#stability-in-code" id="stability-in-code"><h2>Stability in code</h2></a>
<p>The below steps needs to be followed in order to implement
a new unstable feature:</p>
<ol>
<li>
<p>Open a <a href="#tracking-issue">tracking issue</a> -
if you have an RFC, you can use the tracking issue for the RFC.</p>
</li>
<li>
<p>Pick a name for the feature gate (for RFCs, use the name
in the RFC).</p>
</li>
<li>
<p>Add a feature gate declaration to <code>libsyntax/feature_gate.rs</code>
in the active <code>declare_features</code> block:</p>
</li>
</ol>
<pre><code class="language-rust ignore">    // description of feature
    (active, $feature_name, &quot;$current_nightly_version&quot;, Some($tracking_issue_number), $edition)
</code></pre>
<p>where <code>$edition</code> has the type <code>Option&lt;Edition&gt;</code>, and is typically
just <code>None</code>.</p>
<p>For example:</p>
<pre><code class="language-rust ignore">    // allow '|' at beginning of match arms (RFC 1925)
(   active, match_beginning_vert, &quot;1.21.0&quot;, Some(44101), None),
</code></pre>
<p>The current version is not actually important – the important
version is when you are stabilizing a feature.</p>
<ol start="4">
<li>
<p>Prevent usage of the new feature unless the feature gate is set.
You can check it in most places in the compiler using the
expression <code>tcx.features().$feature_name</code> (or
<code>sess.features_untracked().$feature_name</code> if the
tcx is unavailable)</p>
<p>If the feature gate is not set, you should either maintain
the pre-feature behavior or raise an error, depending on
what makes sense.</p>
</li>
<li>
<p>Add a test to ensure the feature cannot be used without
a feature gate, by creating <code>feature-gate-$feature_name.rs</code>
and <code>feature-gate-$feature_name.stderr</code> files under the
<code>src/test/ui/feature-gates</code> directory.</p>
</li>
<li>
<p>Add a section to the unstable book, in
<code>src/doc/unstable-book/src/language-features/$feature_name.md</code>.</p>
</li>
<li>
<p>Write a lots of tests for the new feature.
PRs without tests will not be accepted!</p>
</li>
<li>
<p>Get your PR reviewed and land it. You have now successfully
implemented a feature in Rust!</p>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="walkthrough.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="stabilization_guide.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="walkthrough.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="stabilization_guide.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
